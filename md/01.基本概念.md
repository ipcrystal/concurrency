# 基本概念

## 上下文切换

### 简单理解

即使是单核处理器也支持多线程执行代码，CPU通过给每个线程分配CPU时间片来实现这个机制。
> 时间片是COU分配给各个线程的时间，因为时间片非常短，所以CPU通过不停地切换线程执行，让我们感觉多个线程是同时执行的  
> 时间片一般是几十毫秒（ms）

CPU通过时间片分配算法来执行任务，当前任务执行一个时间片后会切换到下一个任务。但是在切换器会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。

所以任务从保存到再加载的过程就是一次上下文切换

类比读书，都一本英文书的时候，发现某个单词不认识，去查字典，在放下英文书的时候，一定要记住英文书读到哪里了，等查完单词之后，能够继续读这本书。

所以，上下文切换次数多了也会影响多线程的执行效率

### 测试上下文切换次数和时长

使用`Lmbench3`可以测量上下文切换时长

使用`vmstat`可以测量上下文切换的次数

```text
$ vmstat 1
procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----
 r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st
 1  0      0 200652 514180 4260796    0    0     1     9    1    0  1  1 98  0  0
 0  0      0 200596 514180 4260796    0    0     0     0 1907 3595  2  2 97  0  0
 1  0      0 200660 514180 4260800    0    0     0     0 1763 3430  0  2 98  0  0
 0  0      0 200660 514180 4260800    0    0     0     0 1784 3439  2  2 97  0  0
 0  0      0 200660 514180 4260800    0    0     0     0 1736 3385  1  1 98  0  0
```

- CS(Content Switch) 表示上下文切换的次数
- 每1秒切换3000多次上下文

### 如何减少上下文的切换

减少上下文的切换有 无锁并发编程、CAS算法、使用最少线程和使用协程

**无锁并发编程**  
多线程竞争锁的时候，会引起上下文切换，所以多线程处理数据时，可以用一些方法来避免锁，如将数据的ID按照HASH算法取模分段，不同线程处理不同段的数据

**CAS算法**  
Java的Atomic包使用CAS算法来更新数据，而不需要加锁

**使用最少线程**  
避免线程的创建

**使用协程**
在单线程里实现多个任务的调度，并在单线程里位处多个任务间的切换

### 减少上下文线程实战

减少线上大量WAITING的线程，来减少上下文切换次数

**第一步：**用jstack命令dump线程信息，看看pid为3117的进程里的线程都在做什么

```shell
jstack 3117 > /home/winterfell/dump17
```

**第二步：**统计所有线程分别处于什么状态

```shell
grep java.lang.Thread.State dump17 | awk '$2$3$4$5' | sort | uniq -c
```

**第三步：**
打开dump文件查看出去WATING的线程在做什么


## CPU

### CPU术语定义

|术语| 英文单词|术语描述
|:--- | :---:|:---
|内存屏障|memory barriers|是一组处理器命令，用于实现对内存操作的顺序限制
|缓冲行|cache line|CPU高速缓存中可以非陪的最小存储单位。处理器填写缓存行时会加载整个缓存行，现代CPU需要执行几百次CPU指令
|原子操作|atomic operations|不可中断的一个或一系列操作
|缓冲行填充|cache line fill|当处理器识别到从内存中读取操作数是可缓存的，处理器读取整个告诉缓存行到适当的缓存（L1,L2,L3的或所有）
|缓存命中|cache hit|如果高速缓存行填充操作的内存位置仍然是下次处理器访问的地址时，处理器从缓存中读取操作数，而不是从内存读取
|写命中|write hit|当处理器将操作数写会到一个内存缓存的区域时，它首先会检查这个缓存的内存地址是否在缓存行中，如果存在一个有效的缓存行，则处理器将这个操作数写回到缓存，而不是写回到内存。
|写缺少|write miss the cache|一个有效的缓存行被写入到不存在的内存区域


#### 操作数概念
> 操作数是运算符作用于的实体，是表达式中的一个组成部分，它规定了指令中进行数字运算的量  
> 表达式是操作数与操作符的组合。

**定义**
操作数指出指令执行的操作所需要数据的来源。**操作数是汇编语言指令的一个字段**。例如：Mov AX 5678H 操作数（AX 5678H）。在操作数这个字段中可以放操作数本身，也可以放操作地址，还可以放操作地址的计算方法。 [1]

通常一条指令均包含操作符和操作数。例如：在比较指令中操作符指定计算机做比较操作，操作数则指定进行比较的两个数值。

操作数是指令执行的参与者,也就是各种操作的对象.与之有关的是操作码,所谓操作码是说明计算机要执行哪种,如传送,运算,移位,跳转等操作,它是指令中不可缺少的组成部分。

**操作数的形式**
立即操作数：指令要操作的数据以常量的形式出现在指令中，称为立即数，它只能作为源操作数

寄存器操作数：指令要操作的数据存放在CPU中的寄存器里，指令中给出寄存器名即可

内存操作数：指令要操作的数据存放在内存某些单元中，指令中给出内存单元物理地址（实际上指令只给出了偏移地址，段地址采用隐含方式给出，也可以使用跨段方式指出当前段地址）

## 总线BUS
总线（Bus）是计算机各种功能部件之间传送信息的公共通信干线，它是由导线组成的传输线束

按照计算机所传输的信息种类，计算机的总线可以划分为
- 数据总线
- 地址总线
- 控制总线
> 分别用来传输数据、数据地址和控制信号

总线是一种内部结构，它是cpu、内存、输入、输出设备传递信息的公用通道，  
主机的各个部件通过总线相连接，外部设备通过相应的接口电路再与总线相连接，从而形成了计算机硬件系统。

